{% schema %}
{
  "name": "AiRep24 Widget",
  "target": "body",
  "settings": []
}
{% endschema %}

<div id="airep24-root"></div>

<style>
  #airep24-widget-container {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .airep24-avatar-container {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    overflow: hidden;
    position: relative;
    background: rgba(255,255,255,0.2);
  }
  .airep24-avatar-frame {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .airep24-avatar-frame.active {
    opacity: 1;
  }
  .airep24-avatar-frame svg, .airep24-avatar-frame img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
</style>

<script>
  (function() {
    const shop = "{{ shop.permanent_domain }}";
    const apiUrl = "https://app.airep24.com/api/widget-config?shop=" + shop;

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        if (data.enabled) {
          initAiRep24Widget(data);
        }
      })
      .catch(err => console.error("AiRep24 Error:", err));

    function initAiRep24Widget(data) {
      const root = document.getElementById('airep24-root');
      const config = data.config;
      const char = data.character;

      const widget = document.createElement('div');
      widget.id = 'airep24-widget-container';
      widget.style.position = 'fixed';
      widget.style.bottom = '20px';
      widget.style[config.position.split('-')[1]] = '20px';
      widget.style.zIndex = '999999';

      const button = document.createElement('button');
      button.style.backgroundColor = config.primaryColor;
      button.style.color = 'white';
      button.style.border = 'none';
      button.style.borderRadius = config.borderRadius + 'px';
      button.style.padding = '10px 18px';
      button.style.cursor = 'pointer';
      button.style.display = 'flex';
      button.style.alignItems = 'center';
      button.style.gap = '12px';
      button.style.boxShadow = config.shadow ? '0 6px 16px rgba(0,0,0,0.15)' : 'none';
      button.style.opacity = config.opacity / 100;

      // Avatar with 3 frames
      const avatarContainer = document.createElement('div');
      avatarContainer.className = 'airep24-avatar-container';
      
      const frames = [];
      for (let i = 1; i <= 3; i++) {
        const frameDiv = document.createElement('div');
        frameDiv.className = 'airep24-avatar-frame' + (i === 1 ? ' active' : '');
        
        let content = '';
        if (char.avatarType === 'preset') {
          // For presets we assume assets path: assets/presets/idI.svg
          // But since Liquid can't dynamic assets easily, we'll use our API or a generic path
          // For now, let's use a placeholder or the SVG if we had it in DB
          // Actually, our API returns frames.svg1 etc if custom.
          // For presets, let's assume they are in theme assets/airep24-id-i.svg
          const assetName = 'airep24-' + char.avatarId + i + '.svg';
          content = `<img src="https://cdn.shopify.com/s/files/1/0000/0000/t/1/assets/${assetName}" onerror="this.parentElement.innerHTML='<svg viewBox=\'0 0 100 100\'><circle cx=\'50\' cy=\'50\' r=\'40\' fill=\'white\' opacity=\'0.3\'/></svg>'">`;
        } else if (char.avatarType === 'image') {
          const url = char.frames['url' + i] || char.frames.url1;
          content = `<img src="${url}">`;
        } else if (char.avatarType === 'svg') {
          const svg = char.frames['svg' + i] || char.frames.svg1;
          content = svg;
        }

        frameDiv.innerHTML = content;
        avatarContainer.appendChild(frameDiv);
        frames.push(frameDiv);
      }

      // Animation logic
      let currentFrame = 0;
      setInterval(() => {
        frames[currentFrame].classList.remove('active');
        currentFrame = (currentFrame + 1) % 3;
        frames[currentFrame].classList.add('active');
      }, char.animationSpeed || 500);

      const text = document.createElement('span');
      text.style.fontWeight = '600';
      text.style.fontSize = '14px';
      text.innerText = char.name;

      button.appendChild(avatarContainer);
      button.appendChild(text);
      widget.appendChild(button);
      root.appendChild(widget);

      button.onclick = () => {
        alert(char.welcomeMessage);
      };
    }
  })();
</script>
